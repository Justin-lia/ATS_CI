#!/bin/sh
# License: CC0

# 仕様
# 第1引数にIPv6アドレスを渡す。
# IPv6アドレスとして正しい形式なら、省略部分を復元して標準出力へ出力
# 不正なら何も出力せず非0で終了する

# 形式チェックで撥ねられたら即座に終了する
set -e

export LANG=C
ip="$1"

# 文字種のチェック。exprだと改行も普通の文字として扱われるので
# grepを使う時に必要な複数行かどうかの事前チェックを省略できて便利。
expr "$ip" : '[[:xdigit:]:]\{2,\}$' >/dev/null

# grepで文字シーケンスのチェック。-vオプションでマッチ条件を反転させ、
# マッチした時に失敗するようにする。
echo $ip |grep -sqEv '[[:xdigit:]]{5}|:::|::.*::' 

# コロンの数を数える
cn=$(echo $ip |grep -o : |wc -l)
test $cn -ge 2 -a $cn -le 7

ip=$(echo $ip |sed '
# ここからsedスクリプト
# 前後がコロンで終わってたら0を足す
    s/^:/0000:/
    s/:$/:0000/
# 一旦デリミタとしてコロンを前後に足す
    s/.*/:&:/
# 桁が4に満たなかったら先頭に0を付ける、というのを繰り返す(tコマンド)
    :add0
    s/:\([^:]\{1,3\}\):/:0\1:/g
    t add0
#前後のデリミタを再び除く
    s/:\(.*\):/\1/' )

if echo $ip |grep -sq :: 
then
# アドレスが::で省略されている場合…
# 内側のコマンド展開で省略されたフィールドの分を出力
# 外側のコマンド展開のsedで省略が行われたところにはめ込む感じ
## ところで、headではなくtailを使っているのは、POSIXにおいてheadの-cオプションがわざわざ落とされているため。
## tailに似た機能があるからというのが言い分らしいが…。
    ip=$(echo $ip |sed s/::/:$(echo -n :::::: |tail -c $((8-cn)) |sed 's/:/0000:/g')/ )
else
# アドレスの省略がない場合はコロンは7個のはずである
        test $cn -eq 7
fi
# 出力!
echo $ip

